From c0bae29c137f3b83dbce2872ea8e062c97c28743 Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Thu, 9 Apr 2020 18:08:39 +0000
Subject: [PATCH 1/3] Remove linking liblldb to libpython

liblldb doubles as an extension module too, but python
executable is linked to static python. When the extension module
is loaded both the shared libpython and the static libpython symbols
are loaded which leads to a crash in OSX.

To fix this, dependence on PYTHON_LIBRARY is removed from liblldb
and added to its interfaces to make sure the executables like
lldb works fine.

Thanks to feedback from @saulshanabrook

Co-authored-by: Uwe L. Korn <uwelk@xhochy.com>
Co-authored-by: H. Vetinari <h.vetinari@gmx.com>
---
 lldb/cmake/modules/AddLLDB.cmake                            | 3 +++
 lldb/source/API/CMakeLists.txt                              | 6 ++++++
 lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt | 1 -
 .../ScriptInterpreter/Python/Interfaces/CMakeLists.txt      | 1 -
 4 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/lldb/cmake/modules/AddLLDB.cmake b/lldb/cmake/modules/AddLLDB.cmake
index 28bf8d816d89..807e2c57c799 100644
--- a/lldb/cmake/modules/AddLLDB.cmake
+++ b/lldb/cmake/modules/AddLLDB.cmake
@@ -161,6 +161,9 @@ function(add_lldb_executable name)
   endif()
 
   list(APPEND LLVM_LINK_COMPONENTS ${ARG_LINK_COMPONENTS})
+  if (NOT MSVC)
+    list(APPEND LLVM_LINK_COMPONENTS ${Python3_LIBRARIES})
+  endif()
   add_llvm_executable(${name}
     ${pass_NO_INSTALL_RPATH}
     ${ARG_UNPARSED_ARGUMENTS}
diff --git a/lldb/source/API/CMakeLists.txt b/lldb/source/API/CMakeLists.txt
index 4751ed319b25..e4765297a847 100644
--- a/lldb/source/API/CMakeLists.txt
+++ b/lldb/source/API/CMakeLists.txt
@@ -265,6 +265,12 @@ elseif (LLDB_EXPORT_ALL_SYMBOLS)
 endif()
 
 if (NOT MSVC)
+  target_link_libraries(liblldb INTERFACE ${Python3_LIBRARIES})
+  if ( CMAKE_SYSTEM_NAME MATCHES "Darwin" )
+    target_link_options(liblldb PRIVATE -undefined dynamic_lookup)
+  else()
+    target_link_options(liblldb PRIVATE "-Wl,--unresolved-symbols=ignore-all")
+  endif()
   set_target_properties(liblldb
     PROPERTIES
     OUTPUT_NAME lldb
diff --git a/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt b/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
index 3d09cea46446..6d57c0799524 100644
--- a/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
+++ b/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
@@ -37,6 +37,5 @@ add_lldb_library(lldbPluginScriptInterpreterPython PLUGIN
     lldbTarget
     lldbValueObject
     lldbPluginScriptInterpreterPythonInterfaces
-    ${Python3_LIBRARIES}
     ${LLDB_LIBEDIT_LIBS}
   )
diff --git a/lldb/source/Plugins/ScriptInterpreter/Python/Interfaces/CMakeLists.txt b/lldb/source/Plugins/ScriptInterpreter/Python/Interfaces/CMakeLists.txt
index db9e11b73895..3a413c393526 100644
--- a/lldb/source/Plugins/ScriptInterpreter/Python/Interfaces/CMakeLists.txt
+++ b/lldb/source/Plugins/ScriptInterpreter/Python/Interfaces/CMakeLists.txt
@@ -36,7 +36,6 @@ add_lldb_library(lldbPluginScriptInterpreterPythonInterfaces PLUGIN
     lldbHost
     lldbInterpreter
     lldbTarget
-    ${Python3_LIBRARIES}
     ${LLDB_LIBEDIT_LIBS}
   )
 
