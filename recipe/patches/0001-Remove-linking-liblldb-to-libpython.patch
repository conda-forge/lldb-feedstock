From ed9e11f2ba546a36acc3ce1315779ded6311a859 Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Thu, 9 Apr 2020 18:08:39 +0000
Subject: [PATCH] Remove linking liblldb to libpython

Co-authored-by: Uwe L. Korn <uwelk@xhochy.com>

liblldb doubles as an extension module too, but python
executable is linked to static python. When the extension module
is loaded both the shared libpython and the static libpython symbols
are loaded which leads to a crash in OSX.

To fix this, dependence on PYTHON_LIBRARY is removed from liblldb
and added to its interfaces to make sure the executables like
lldb works fine.

Thanks to feedback from @saulshanabrook
---
 lldb/cmake/modules/AddLLDB.cmake                            | 3 +++
 lldb/source/API/CMakeLists.txt                              | 6 ++++++
 lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt | 1 -
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/lldb/cmake/modules/AddLLDB.cmake b/lldb/cmake/modules/AddLLDB.cmake
index a5be4afb4..e9f03b039 100644
--- a/lldb/cmake/modules/AddLLDB.cmake
+++ b/lldb/cmake/modules/AddLLDB.cmake
@@ -164,6 +164,9 @@ function(add_lldb_executable name)
   endif()
 
   list(APPEND LLVM_LINK_COMPONENTS ${ARG_LINK_COMPONENTS})
+  if (NOT MSVC)
+    list(APPEND LLVM_LINK_COMPONENTS ${Python3_LIBRARIES})
+  endif()
   add_llvm_executable(${name}
     ${pass_ENTITLEMENTS}
     ${pass_NO_INSTALL_RPATH}
diff --git a/lldb/source/API/CMakeLists.txt b/lldb/source/API/CMakeLists.txt
index 3e189f387..9d3de7f2e 100644
--- a/lldb/source/API/CMakeLists.txt
+++ b/lldb/source/API/CMakeLists.txt
@@ -180,6 +180,12 @@ if (NOT CMAKE_SYSTEM_NAME MATCHES "Windows")
 endif()
 
 if (NOT MSVC)
+  target_link_libraries(liblldb INTERFACE ${Python3_LIBRARIES})
+  if ( CMAKE_SYSTEM_NAME MATCHES "Darwin" )
+    target_link_options(liblldb PRIVATE -undefined dynamic_lookup)
+  else()
+    target_link_options(liblldb PRIVATE "-Wl,--unresolved-symbols=ignore-all")
+  endif()
   set_target_properties(liblldb
     PROPERTIES
     OUTPUT_NAME lldb
diff --git a/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt b/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
index d59b7bbf6..80acb7fba 100644
--- a/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
+++ b/lldb/source/Plugins/ScriptInterpreter/Python/CMakeLists.txt
@@ -29,7 +29,6 @@ add_lldb_library(lldbPluginScriptInterpreterPython PLUGIN
     lldbHost
     lldbInterpreter
     lldbTarget
-    ${Python3_LIBRARIES}
     ${LLDB_LIBEDIT_LIBS}
 
   LINK_COMPONENTS
-- 
2.39.3 (Apple Git-145)

